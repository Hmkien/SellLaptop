@model List<Product>
@using WebsiteSellLaptop.Models.Enums

@{
    ViewData["Title"] = "Quản lý sản phẩm";
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var totalItems = ViewBag.TotalItems ?? 0;
    var pageSize = ViewBag.PageSize ?? 10;
    var keyword = ViewBag.Keyword as string;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold mb-0"><i class="bi bi-laptop me-2"></i>Quản lý sản phẩm</h4>
    <a asp-action="Create" class="btn btn-brand"><i class="bi bi-plus-lg me-1"></i>Thêm mới</a>
</div>

<div class="admin-card mb-4">
    <form method="get" class="row g-3 align-items-end p-3">
        <div class="col-md-8">
            <label class="form-label fw-semibold">Tìm kiếm</label>
            <input type="text" name="keyword" value="@keyword" class="form-control" placeholder="Nhập mã hoặc tên sản phẩm...">
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-brand w-100"><i class="bi bi-search me-1"></i>Tìm kiếm</button>
        </div>
    </form>
</div>

<div class="admin-card p-0">
    <div class="table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th width="60">STT</th>
                    <th width="80">Mã</th>
                    <th width="60">Ảnh</th>
                    <th>Tên sản phẩm</th>
                    <th>Danh mục</th>
                    <th>Thương hiệu</th>
                    <th>Giá</th>
                    <th width="80">Kho</th>
                    <th width="130">Trạng thái</th>
                    <th width="120">Ngày tạo</th>
                    <th width="180">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model == null || Model.Count == 0)
                {
                    <tr><td colspan="11" class="text-center text-muted py-4">Không có dữ liệu</td></tr>
                }
                else
                {
                    var sttBase = (currentPage - 1) * pageSize;
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        var item = Model[i];
                        var stt = sttBase + i + 1;
                        <tr>
                            <td class="text-center">@stt</td>
                            <td><a asp-action="Detail" asp-route-id="@item.Id" class="text-primary fw-semibold">@item.Code</a></td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.ThumbnailUrl))
                                {
                                    <img src="@item.ThumbnailUrl" alt="" style="width: 44px; height: 44px; object-fit: cover; border-radius: 8px;">
                                }
                            </td>
                            <td>
                                <a asp-action="Detail" asp-route-id="@item.Id" class="text-primary fw-semibold">@item.Name</a>
                                @if (!string.IsNullOrEmpty(item.ShortDescription))
                                {
                                    <div class="text-muted small mt-1" style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@item.ShortDescription</div>
                                }
                            </td>
                            <td><span class="text-muted">@item.Category?.Name</span></td>
                            <td><span class="text-muted">@item.Brand?.Name</span></td>
                            <td>
                                <span class="fw-semibold text-danger">@item.Price.ToString("N0")đ</span>
                                @if (item.DiscountPrice.HasValue && item.DiscountPrice > 0)
                                {
                                    <br><small class="text-decoration-line-through text-muted">@item.DiscountPrice.Value.ToString("N0")đ</small>
                                }
                            </td>
                            <td class="text-center">
                                <span class="badge bg-@(item.StockQuantity > 0 ? "success" : "danger") bg-opacity-10 text-@(item.StockQuantity > 0 ? "success" : "danger")">@item.StockQuantity</span>
                            </td>
                            <td>
                                @switch (item.Status)
                                {
                                    case StatusEntity.Approved: <span class="badge-status approved"><i class="bi bi-check-circle me-1"></i>Đã duyệt</span> break;
                                    case StatusEntity.Pending: <span class="badge-status pending"><i class="bi bi-clock me-1"></i>Chờ duyệt</span> break;
                                    case StatusEntity.Rejected: <span class="badge-status rejected"><i class="bi bi-x-circle me-1"></i>Hủy duyệt</span> break;
                                    case StatusEntity.Draft: <span class="badge-status draft"><i class="bi bi-pencil me-1"></i>Nháp</span> break;
                                }
                            </td>
                            <td>@item.Created.ToString("dd/MM/yyyy")</td>
                            <td>
                                <div class="d-flex gap-1 align-items-center">
                                    @if (item.Status == StatusEntity.Approved)
                                    {
                                        <button type="button" class="action-icon action-reject" title="Hủy duyệt" onclick="confirmReject('@item.Id', '@item.Name')"><i class="bi bi-x-circle-fill"></i></button>
                                    }
                                    else
                                    {
                                        <button type="button" class="action-icon action-approve" title="Duyệt" onclick="confirmApprove('@item.Id', '@item.Name')"><i class="bi bi-check-circle-fill"></i></button>
                                        <a asp-action="Edit" asp-route-id="@item.Id" class="action-icon action-edit" title="Sửa"><i class="bi bi-pencil-square"></i></a>
                                        <button type="button" class="action-icon action-delete" title="Xóa" onclick="confirmDelete('@item.Id', '@item.Name')"><i class="bi bi-trash3-fill"></i></button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    @if (totalPages > 1)
    {
        <div class="admin-pagination">
            <div class="pg-info">Hiển thị @(((currentPage - 1) * pageSize) + 1) - @Math.Min(currentPage * pageSize, totalItems) / @totalItems bản ghi</div>
            <div class="pg-list">
                @if (currentPage > 1) { <a href="@Url.Action("Index", new { page = 1, keyword })">«</a> <a href="@Url.Action("Index", new { page = currentPage - 1, keyword })">‹</a> } else { <span class="disabled">«</span> <span class="disabled">‹</span> }
                @{ var start = Math.Max(1, currentPage - 2); var end = Math.Min(totalPages, currentPage + 2); }
                @for (int p = start; p <= end; p++) { if (p == currentPage) { <span class="active">@p</span> } else { <a href="@Url.Action("Index", new { page = p, keyword })">@p</a> } }
                @if (currentPage < totalPages) { <a href="@Url.Action("Index", new { page = currentPage + 1, keyword })">›</a> <a href="@Url.Action("Index", new { page = totalPages, keyword })">»</a> } else { <span class="disabled">›</span> <span class="disabled">»</span> }
            </div>
        </div>
    }
</div>

<!-- Modals -->
<div class="modal fade" id="deleteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Xác nhận xóa</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Bạn có chắc chắn muốn xóa sản phẩm <strong id="deleteItemName"></strong>?</p></div><div class="modal-footer"><input type="hidden" id="deleteItemId"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-danger" onclick="doDelete()">Xóa</button></div></div></div></div>
<div class="modal fade" id="approveModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>Xác nhận duyệt</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Bạn có chắc chắn muốn duyệt sản phẩm <strong id="approveItemName"></strong>?</p></div><div class="modal-footer"><input type="hidden" id="approveItemId"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-success" onclick="doApprove()">Duyệt</button></div></div></div></div>
<div class="modal fade" id="rejectModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title"><i class="bi bi-x-circle me-2"></i>Xác nhận hủy duyệt</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Bạn có chắc chắn muốn hủy duyệt sản phẩm <strong id="rejectItemName"></strong>?</p></div><div class="modal-footer"><input type="hidden" id="rejectItemId"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-warning" onclick="doReject()">Hủy duyệt</button></div></div></div></div>
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"><div id="toast" class="toast" role="alert"><div class="toast-header"><i class="bi me-2" id="toastIcon"></i><strong class="me-auto" id="toastTitle">Thông báo</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div class="toast-body" id="toastMessage"></div></div></div>

@section Scripts {
<script>
    const baseUrl = '@Url.Action("Index", "Product", new { area = "Admin" })'.replace('/Index', '');
    function showToast(message, type = 'success') { const toast = document.getElementById('toast'); toast.classList.remove('bg-success', 'bg-danger', 'text-white'); document.getElementById('toastIcon').classList.remove('bi-check-circle-fill', 'bi-x-circle-fill'); if (type === 'success') { toast.classList.add('bg-success', 'text-white'); document.getElementById('toastIcon').classList.add('bi-check-circle-fill'); document.getElementById('toastTitle').textContent = 'Thành công'; } else { toast.classList.add('bg-danger', 'text-white'); document.getElementById('toastIcon').classList.add('bi-x-circle-fill'); document.getElementById('toastTitle').textContent = 'Lỗi'; } document.getElementById('toastMessage').textContent = message; new bootstrap.Toast(toast).show(); }
    function confirmDelete(id, name) { document.getElementById('deleteItemId').value = id; document.getElementById('deleteItemName').textContent = name; new bootstrap.Modal(document.getElementById('deleteModal')).show(); }
    function confirmApprove(id, name) { document.getElementById('approveItemId').value = id; document.getElementById('approveItemName').textContent = name; new bootstrap.Modal(document.getElementById('approveModal')).show(); }
    function confirmReject(id, name) { document.getElementById('rejectItemId').value = id; document.getElementById('rejectItemName').textContent = name; new bootstrap.Modal(document.getElementById('rejectModal')).show(); }
    async function doDelete() { const formData = new FormData(); formData.append('id', document.getElementById('deleteItemId').value); formData.append('__RequestVerificationToken', '@Html.AntiForgeryToken()'.match(/value="([^"]+)"/)?.[1] || ''); const r = await fetch(`${baseUrl}/Delete`, { method: 'POST', body: formData }); const result = await r.json(); showToast(result.message, result.success ? 'success' : 'error'); if (result.success) { bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide(); setTimeout(() => location.reload(), 1000); } }
    async function doApprove() { const formData = new FormData(); formData.append('id', document.getElementById('approveItemId').value); formData.append('__RequestVerificationToken', '@Html.AntiForgeryToken()'.match(/value="([^"]+)"/)?.[1] || ''); const r = await fetch(`${baseUrl}/Approve`, { method: 'POST', body: formData }); const result = await r.json(); showToast(result.message, result.success ? 'success' : 'error'); if (result.success) { bootstrap.Modal.getInstance(document.getElementById('approveModal')).hide(); setTimeout(() => location.reload(), 1000); } }
    async function doReject() { const formData = new FormData(); formData.append('id', document.getElementById('rejectItemId').value); formData.append('__RequestVerificationToken', '@Html.AntiForgeryToken()'.match(/value="([^"]+)"/)?.[1] || ''); const r = await fetch(`${baseUrl}/Reject`, { method: 'POST', body: formData }); const result = await r.json(); showToast(result.message, result.success ? 'success' : 'error'); if (result.success) { bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide(); setTimeout(() => location.reload(), 1000); } }
</script>
}
